<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<head>
    <link rel="icon" th:href="@{/favicon.ico}" />
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CATTALK</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" th:href="@{/css/fonts-local.css}">




    
</head>

<body class="h-screen max-w-[60rem] m-auto noto-sans-kr flex flex-col">


    <header>
        <div th:replace="~{layout/header :: header}"></div>
        <div class="relative">
            <div
                class="w-3/4 px-5 py-3 absolute -bottom-16 left-1/2 -translate-x-1/2 bg-white rounded-3xl flex items-center justify-center">
                <input type="text" id="findNickname" name="findNickname" placeholder="친구 닉네임을 입력해주세요"
                    class="w-5/6 outline-none focus:placeholder-transparent text-center placeholder:text-center" />
                <button id="searchButton" class="w-1/6">
                    검색
                </button>
            </div>
        </div>
    </header>


    <div class="flex-1 bg-amber-700/30 overflow-y-auto">
        <ul id="searchResults" class="mt-20">
            <!-- 검색 결과가 여기에 표시됩니다 -->
        </ul>
    </div>


    <footer>
        <div th:replace="~{layout/footer :: footer}"></div>
    </footer>

    

    <div id="modalContainer" class="hidden fixed inset-0 bg-black bg-opacity-50">
        <!-- 선택 모달 창 -->
        <div id="confirmModal" class="hidden absolute bottom-1/2 left-1/2 -translate-x-1/2 bg-white rounded-lg p-6 w-2/3 lg:w-1/3
            opacity-0 translate-y-4 transform transition-all duration-300 ease-in-out">
            <p class="text-xl mb-4">친구추가 하시겠습니까?</p>
            <div class="flex justify-end">
                <button id="confirmButton"
                    class="bg-amber-700 text-white px-4 py-2 rounded hover:opacity-30 mr-2">
                    확인
                </button>
                <button id="cancelButton"
                    class="bg-gray-500 text-white px-4 py-2 rounded hover:opacity-30">
                    취소
                </button>
            </div>
        </div>

        <!-- 완료 모달 창 -->
        <div id="successModal" class="hidden absolute bottom-1/2 left-1/2 -translate-x-1/2 bg-white rounded-lg p-6 w-2/3 lg:w-1/3
            opacity-0 translate-y-0 transform transition-all duration-300 ease-in-out">
            <p class="text-xl mb-4">친구추가가 완료되었습니다.</p>
        </div>

    </div>


</body>

<script>
    document.addEventListener('DOMContentLoaded', function () {

        // 멤버 목록 html 틀
        const getList = (nickname, profileImage) => {
            return `<li>
                        <div class="bg-amber-700 bg-opacity-0 hover:bg-opacity-30 cursor-pointer friend-item" data-nickname="${nickname}">
                            <div class="flex items-center p-5">
                                <img src="/images/profile_default.png" alt="프로필 이미지"
                                    class="rounded-full w-16 h-16 object-contain" />
                                <div class="text-2xl px-5">${nickname}</div>
                            </div>
                        </div>
                    </li>`;
        }

        // 검색 버튼 클릭시
        document.getElementById('searchButton').addEventListener('click', function () {
            searchNickname();
        });

        // 단축키 설정 (Enter 키)
        document.getElementById("findNickname").addEventListener("keydown", (e) => {
            if (e.key === 'Enter') {
                searchNickname();
            }
        });

        // 닉네임으로 사용자 검색
        function searchNickname() {
            const nickname = document.getElementById('findNickname').value.trim();

            if (nickname) {
                fetch(`/api/user?nickname=${encodeURIComponent(nickname)}`)
                    .then(response => response.json())
                    .then(data => {
                        renderResults(data);
                        // 검색 후 입력 필드 초기화
                        document.getElementById('findNickname').value = '';
                    })
                    .catch(error => console.error('Error:', error));
            }
        }

        // 검색 결과 렌더링
        function renderResults(users) {
            const resultsContainer = document.getElementById('searchResults');
            resultsContainer.innerHTML = ''; // 이전 결과 삭제

            if (users.length === 0) {
                resultsContainer.innerHTML =
                    `<li>
                        <div class="flex items-center justify-center h-32">
                            검색 결과가 없습니다.
                        </div>
                    </li>`;
                return;
            }

            users.forEach(user => {
                const listItemHTML = getList(user.nickname, user.profileImage);
                resultsContainer.insertAdjacentHTML('beforeend', listItemHTML);
            });

            // 친구 항목에 클릭 이벤트 리스너 추가
            const friendItems = document.querySelectorAll('.friend-item');
            friendItems.forEach(item => {
                item.addEventListener('click', function () {
                    initModalPosition();
                    const selectedNickname = this.getAttribute('data-nickname');
                    setNickname(selectedNickname);
                    openConfirmModal();
                });
            });
        }


        // 선택된 친구의 닉네임
        let selectedNickname = '';

        function setNickname(nickname){
            selectedNickname = nickname;
        }


        // 선택 모달 열기
        function openConfirmModal() {
            const modalContainer = document.getElementById('modalContainer');
            const confirmModal = document.getElementById('confirmModal');

            setTimeout(() => {
                modalContainer.classList.remove('hidden');
                confirmModal.classList.remove('hidden');
            },10);

            setTimeout(() => {
                confirmModal.classList.remove('opacity-0', 'translate-y-4');
                confirmModal.classList.add('opacity-100', 'translate-y-0');
            },20);
        }


        // 선택 모달 닫기
        function closeConfirmModal() {
            const confirmModal = document.getElementById('confirmModal');

            setTimeout(() => {
                confirmModal.classList.remove('opacity-100', 'translate-y-0');
                confirmModal.classList.add('opacity-0', '-translate-y-4');
            },10);

            setTimeout(() => {
                confirmModal.classList.add('hidden');
            },20);
        }

        // 완료 모달
        function showSuccessModal() {
            const modalContainer = document.getElementById('modalContainer');
            const successModal = document.getElementById('successModal');

            setTimeout(() => {
                successModal.classList.remove('hidden');
            },10);

            setTimeout(() => {
                successModal.classList.remove('opacity-0', 'translate-y-0');
                successModal.classList.add('opacity-100', '-translate-y-4');
            },20);

            setTimeout(() => {
                successModal.classList.remove('opacity-100', '-translate-y-4');
                successModal.classList.add('opacity-0', '-translate-y-8');
            },1000);

            setTimeout(() => {
                successModal.classList.add('hidden');
                modalContainer.classList.add('hidden');
            },1500);
        }


        // 선택 모달 확인 버튼
        document.getElementById('confirmButton').addEventListener('click', function () {
            closeConfirmModal();
            addFriend(selectedNickname);
        });

        // 선택 모달 취소 버튼
        document.getElementById('cancelButton').addEventListener('click', function () {
            closeConfirmModal();
            const modalContainer = document.getElementById('modalContainer');
            modalContainer.classList.add('hidden');
        });


        // 애니메이션 끝난 모달창 위치초기화
        function initModalPosition(){
            const confirmModal = document.getElementById('confirmModal');
            const successModal = document.getElementById('successModal');

            confirmModal.classList.remove('-translate-y-4');
            successModal.classList.remove('-translate-y-8');
            confirmModal.classList.add('translate-y-4');
            successModal.classList.add('translate-y-0');
        }




    

        // 친구 추가 API 호출
        function addFriend(friendNickname) {

            let formData = new FormData();
            formData.append('friendNickname', friendNickname);

            fetch('/api/friend', {
                method: 'POST',
                body: formData
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('친구 추가에 실패했습니다.');
                }
                // 완료 모달 창 표시
                showSuccessModal();
            })
            .catch(error => {
                console.error('Error:', error);
                alert('친구 추가 중 오류가 발생했습니다.');
                const modalContainer = document.getElementById('modalContainer');
                modalContainer.classList.add('hidden');
            });
        }

    });
</script>

</html>