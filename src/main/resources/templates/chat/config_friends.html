<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<head>
    <link rel="icon" th:href="@{/favicon.ico}" />
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CATTALK</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" th:href="@{/css/fonts-local.css}">

</head>

<body class="h-screen max-w-[60rem] m-auto noto-sans-kr flex flex-col">
    
    
    <header>
        <div th:replace="~{layout/header :: header}"></div>
    </header>


    <div class="flex-1 bg-amber-700/30 overflow-y-auto">
        <div th:text="|친구 ${friends.size()}명|"
            class="px-5 pb-1 pt-2 text-sm"></div>
        <ul>
            <li th:each="friend : ${friends}">
                <div class="flex items-center p-5">
                    <img th:src="@{/images/profile_default.png}" alt="프로필 이미지"
                        class="rounded-full w-16 h-16 object-contain" />
                    <div th:text="${friend.nickname}"
                        class="text-2xl px-5"></div>
                    <button class="ml-auto text-xl px-5 py-2 bg-red-600 rounded text-white hover:opacity-30"
                        th:data-friend-nickname="${friend.nickname}"
                        onclick="handleClickDelete(this)">
                        삭제
                    </button>
                </div>
            </li>
        </ul>
    </div>
    

    <footer>
        <div th:replace="~{layout/footer :: footer}"></div>
    </footer>




    <div id="modalContainer" class="hidden fixed inset-0 bg-black bg-opacity-50">
        <!-- 선택 모달 창 -->
        <div id="confirmModal" class="hidden absolute bottom-1/2 left-1/2 -translate-x-1/2 bg-white rounded-lg p-6 w-2/3 lg:w-1/3
            opacity-0 translate-y-4 transform transition-all duration-300 ease-in-out">
            <p class="text-xl mb-4">정말로 삭제 하시겠습니까?</p>
            <div class="flex justify-end">
                <button id="confirmButton"
                    class="bg-red-600 text-white px-4 py-2 rounded hover:opacity-30 mr-2">
                    확인
                </button>
                <button id="cancelButton"
                    class="bg-gray-500 text-white px-4 py-2 rounded hover:opacity-30">
                    취소
                </button>
            </div>
        </div>

        <!-- 완료 모달 창 -->
        <div id="successModal" class="hidden absolute bottom-1/2 left-1/2 -translate-x-1/2 bg-white rounded-lg p-6 w-2/3 lg:w-1/3
            opacity-0 translate-y-0 transform transition-all duration-300 ease-in-out">
            <p class="text-xl mb-4">친구 삭제가 완료되었습니다.</p>
        </div>

    </div>


</body>

<script>

        // 선택된 친구의 닉네임
        let selectedNickname = '';

        function setNickname(nickname){
            selectedNickname = nickname;
        }


        // 첫 화면 삭제 버튼 클릭시
        function handleClickDelete(element){
            initModalPosition();
            const nickname = element.getAttribute('data-friend-nickname');
            setNickname(nickname);
            openConfirmModal();
        }


        // 선택 모달 열기
        function openConfirmModal() {
            const modalContainer = document.getElementById('modalContainer');
            const confirmModal = document.getElementById('confirmModal');

            setTimeout(() => {
                modalContainer.classList.remove('hidden');
                confirmModal.classList.remove('hidden');
            },10);

            setTimeout(() => {
                confirmModal.classList.remove('opacity-0', 'translate-y-4');
                confirmModal.classList.add('opacity-100', 'translate-y-0');
            },20);
        }


        // 선택 모달 닫기
        function closeConfirmModal() {
            const confirmModal = document.getElementById('confirmModal');

            setTimeout(() => {
                confirmModal.classList.remove('opacity-100', 'translate-y-0');
                confirmModal.classList.add('opacity-0', '-translate-y-4');
            },10);

            setTimeout(() => {
                confirmModal.classList.add('hidden');
            },20);
        }


        // 완료 모달
        function showSuccessModal() {
            const modalContainer = document.getElementById('modalContainer');
            const successModal = document.getElementById('successModal');

            setTimeout(() => {
                successModal.classList.remove('hidden');
            },10);

            setTimeout(() => {
                successModal.classList.remove('opacity-0', 'translate-y-0');
                successModal.classList.add('opacity-100', '-translate-y-4');
            },20);

            setTimeout(() => {
                successModal.classList.remove('opacity-100', '-translate-y-4');
                successModal.classList.add('opacity-0', '-translate-y-8');
            },1000);

            setTimeout(() => {
                window.location.reload();
            },1500);
        }


        // 선택 모달 확인 버튼
        document.getElementById('confirmButton').addEventListener('click', function () {
            closeConfirmModal();
            deleteFriend(selectedNickname);
        });


        // 선택 모달 취소 버튼
        document.getElementById('cancelButton').addEventListener('click', function () {
            closeConfirmModal();
            const modalContainer = document.getElementById('modalContainer');
            modalContainer.classList.add('hidden');
        });


        // 애니메이션 끝난 모달창 위치초기화
        function initModalPosition(){
            const confirmModal = document.getElementById('confirmModal');
            const successModal = document.getElementById('successModal');

            confirmModal.classList.remove('-translate-y-4');
            successModal.classList.remove('-translate-y-8');
            confirmModal.classList.add('translate-y-4');
            successModal.classList.add('translate-y-0');
        }



        // 친구 삭제 API 호출
        function deleteFriend(friendNickname) {

            fetch(`/api/friend/${friendNickname}`, {
                method: 'DELETE'
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('친구 삭제에 실패했습니다.');
                }
                // 완료 모달 창 표시
                showSuccessModal();
            })
            .catch(error => {
                console.error('Error: ', error);
                alert('친구 삭제 중 오류가 발생했습니다.');
                const modalContainer = document.getElementById('modalContainer');
                modalContainer.classList.add('hidden');
            });
        }
</script>

</html>